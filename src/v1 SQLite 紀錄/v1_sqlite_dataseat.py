# -*- coding: utf-8 -*-
"""v1_sqlite_dataseat.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ZeQ0CMo2tAJpJLZlJ_L-p_1IzTjpR26J
"""

# -*- coding: utf-8 -*-
"""v1_SQLite_dataseat.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/17pEn55UZQDyh7UUPS2cwXva78Jx0Aumx
"""

import os
import sqlite3
from datetime import datetime
from flask import g # é€™æ˜¯ç”¨æ–¼ Flask æ‡‰ç”¨ç¨‹å¼é€£ç·šç®¡ç†çš„é—œéµ

# ----------------------------------------------------
# ğŸ’¡ æ•¸æ“šæŒä¹…åŒ–è¨­å®šï¼šGoogle Drive è·¯å¾‘
# ----------------------------------------------------
# è«‹ç¢ºä¿æ‚¨åœ¨ Colab ä¸­å·²ç¶“åŸ·è¡Œäº†ï¼šfrom google.colab import drive; drive.mount('/content/drive')
# é€™å€‹è·¯å¾‘æ˜¯ Colab è™›æ“¬æ©Ÿå­˜å–æ‚¨ Google Drive çš„æ¨™æº–å…¥å£
DRIVE_BASE_PATH = '/content/drive/MyDrive/projects/'

# å»ºè­°ï¼šå°‡è³‡æ–™åº«æ”¾åœ¨æ‚¨ Drive å…§çš„ä¸€å€‹å°ˆå±¬è³‡æ–™å¤¾
# æ‚¨å¯ä»¥å°‡ 'LineBot_Data' æ›¿æ›ç‚ºä»»ä½•æ‚¨å–œæ­¡çš„è³‡æ–™å¤¾åç¨±
PROJECT_DATA_FOLDER = 'LineBot_Data'

# æœ€çµ‚è³‡æ–™åº«æª”æ¡ˆçš„å®Œæ•´è·¯å¾‘
DB_DIR = os.path.join(DRIVE_BASE_PATH, PROJECT_DATA_FOLDER)
DB_NAME = os.path.join(DB_DIR, 'emotion_diary.db')
# ----------------------------------------------------

def get_db():
    """ç²å–è³‡æ–™åº«é€£ç·šã€‚ç¢ºä¿åœ¨å–®å€‹è«‹æ±‚ä¸­åªé€£ç·šä¸€æ¬¡ã€‚"""
    if 'db' not in g:
        g.db = sqlite3.connect(DB_NAME)
        g.db.row_factory = sqlite3.Row
    return g.db

def close_db(e=None):
    """é—œé–‰è³‡æ–™åº«é€£ç·šï¼Œåœ¨ Flask è«‹æ±‚çµæŸæ™‚æœƒè¢«å‘¼å«ã€‚"""
    db = g.pop('db', None)
    if db is not None:
        db.close()

def init_db():
    """åˆå§‹åŒ–è³‡æ–™åº«ï¼šå»ºç«‹è³‡æ–™å¤¾èˆ‡è³‡æ–™è¡¨"""

    # ğŸŒŸ é—œéµï¼šå¦‚æœè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œå°±å‰µå»ºå®ƒ ğŸŒŸ
    if not os.path.exists(DB_DIR):
        print(f"è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œæ­£åœ¨å‰µå»º: {DB_DIR}")
        os.makedirs(DB_DIR)

    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()

    # å»ºç«‹è³‡æ–™è¡¨ï¼ŒåŒ…å« V1 åˆ° V3 æ‰€æœ‰éœ€è¦çš„æ¬„ä½
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS diary_logs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            timestamp TEXT NOT NULL,
            raw_text TEXT,
            sentiment TEXT,
            score REAL,
            keywords TEXT
        )
    ''')
    conn.commit()
    conn.close()
    print(f"âœ… è³‡æ–™åº« {DB_NAME} åˆå§‹åŒ–å®Œæˆï¼Œè³‡æ–™å°‡æ°¸ä¹…å„²å­˜åœ¨ Google Drive ä¸Šã€‚")


def insert_log(user_id, raw_text, sentiment='Neutral', score=0.0, keywords='[]'):
    """å°‡æ—¥è¨˜è¨˜éŒ„å­˜å…¥è³‡æ–™åº« (ä½¿ç”¨ g.db é€£ç·š)ã€‚"""
    db = get_db()
    current_time = datetime.now().isoformat()
    db.execute(
        """
        INSERT INTO diary_logs
        (user_id, timestamp, raw_text, sentiment, score, keywords)
        VALUES (?, ?, ?, ?, ?, ?)
        """,
        (user_id, current_time, raw_text, sentiment, score, keywords)
    )
    db.commit()

def get_user_log_count(user_id):
    """æŸ¥è©¢ä½¿ç”¨è€…ç¸½å…±å¯«äº†å¤šå°‘ç¯‡æ—¥è¨˜ã€‚"""
    db = get_db()
    result = db.execute(
        "SELECT COUNT(id) FROM diary_logs WHERE user_id = ?",
        (user_id,)
    ).fetchone()
    # fetchone() è¿”å›çš„æ˜¯ä¸€å€‹ tupleï¼Œå–ç¬¬ä¸€å€‹å…ƒç´ å°±æ˜¯æ•¸é‡
    return result[0] if result else 0

if __name__ == '__main__':
    # é¦–æ¬¡é‹è¡Œ database.py æ™‚ï¼ŒæœƒåŸ·è¡Œåˆå§‹åŒ–
    init_db()