# -*- coding: utf-8 -*-
"""v1_sqlite_dataseat.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ZeQ0CMo2tAJpJLZlJ_L-p_1IzTjpR26J
"""

# -*- coding: utf-8 -*-
"""v1_SQLite_dataseat.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/17pEn55UZQDyh7UUPS2cwXva78Jx0Aumx
"""

from flask import g
from datetime import datetime, timedelta
import sqlite3
import os

# ----------------------------------------------------
# ğŸ’¡ æ•¸æ“šæŒä¹…åŒ–è¨­å®šï¼šGoogle Drive è·¯å¾‘
# ----------------------------------------------------
# è«‹ç¢ºä¿æ‚¨åœ¨ Colab ä¸­å·²ç¶“åŸ·è¡Œäº†ï¼šfrom google.colab import drive; drive.mount('/content/drive')
# é€™å€‹è·¯å¾‘æ˜¯ Colab è™›æ“¬æ©Ÿå­˜å–æ‚¨ Google Drive çš„æ¨™æº–å…¥å£
DRIVE_BASE_PATH = '/content/drive/MyDrive/projects/'

# å»ºè­°ï¼šå°‡è³‡æ–™åº«æ”¾åœ¨æ‚¨ Drive å…§çš„ä¸€å€‹å°ˆå±¬è³‡æ–™å¤¾
# æ‚¨å¯ä»¥å°‡ 'LineBot_Data' æ›¿æ›ç‚ºä»»ä½•æ‚¨å–œæ­¡çš„è³‡æ–™å¤¾åç¨±
PROJECT_DATA_FOLDER = 'LineBot_Data'

# æœ€çµ‚è³‡æ–™åº«æª”æ¡ˆçš„å®Œæ•´è·¯å¾‘
DB_DIR = os.path.join(DRIVE_BASE_PATH, PROJECT_DATA_FOLDER)
DB_NAME = os.path.join(DB_DIR, 'emotion_diary.db')
# ----------------------------------------------------


def get_db():
    """ç²å–è³‡æ–™åº«é€£ç·šã€‚ç¢ºä¿åœ¨å–®å€‹è«‹æ±‚ä¸­åªé€£ç·šä¸€æ¬¡ã€‚"""
    if 'db' not in g:
        g.db = sqlite3.connect(DB_NAME)
        g.db.row_factory = sqlite3.Row
    return g.db


def close_db(e=None):
    """é—œé–‰è³‡æ–™åº«é€£ç·šï¼Œåœ¨ Flask è«‹æ±‚çµæŸæ™‚æœƒè¢«å‘¼å«ã€‚"""
    db = g.pop('db', None)
    if db is not None:
        db.close()


def init_db():
    """åˆå§‹åŒ–è³‡æ–™åº«ï¼šå»ºç«‹è³‡æ–™å¤¾èˆ‡è³‡æ–™è¡¨"""

    # ğŸŒŸ é—œéµï¼šå¦‚æœè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œå°±å‰µå»ºå®ƒ ğŸŒŸ
    if not os.path.exists(DB_DIR):
        print(f"è³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œæ­£åœ¨å‰µå»º: {DB_DIR}")
        os.makedirs(DB_DIR)

    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()

    # å»ºç«‹è³‡æ–™è¡¨ï¼ŒåŒ…å« V1 åˆ° V3 æ‰€æœ‰éœ€è¦çš„æ¬„ä½
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS diary_logs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            timestamp TEXT NOT NULL,
            raw_text TEXT,
            sentiment TEXT,
            score REAL,
            keywords TEXT
        )
    ''')
    conn.commit()
    conn.close()
    print(f"âœ… è³‡æ–™åº« {DB_NAME} åˆå§‹åŒ–å®Œæˆï¼Œè³‡æ–™å°‡æ°¸ä¹…å„²å­˜åœ¨ Google Drive ä¸Šã€‚")


def insert_log(user_id, raw_text, sentiment='Neutral', score=0.0, keywords='[]'):
    """å°‡æ—¥è¨˜è¨˜éŒ„å­˜å…¥è³‡æ–™åº« (ä½¿ç”¨ g.db é€£ç·š)ã€‚"""
    db = get_db()
    current_time = datetime.now().isoformat()
    db.execute(
        """
        INSERT INTO diary_logs
        (user_id, timestamp, raw_text, sentiment, score, keywords)
        VALUES (?, ?, ?, ?, ?, ?)
        """,
        (user_id, current_time, raw_text, sentiment, score, keywords)
    )
    db.commit()


def get_user_log_count(user_id):
    """æŸ¥è©¢ä½¿ç”¨è€…ç¸½å…±å¯«äº†å¤šå°‘ç¯‡æ—¥è¨˜ã€‚"""
    db = get_db()
    result = db.execute(
        "SELECT COUNT(id) FROM diary_logs WHERE user_id = ?",
        (user_id,)
    ).fetchone()
    # fetchone() è¿”å›çš„æ˜¯ä¸€å€‹ tupleï¼Œå–ç¬¬ä¸€å€‹å…ƒç´ å°±æ˜¯æ•¸é‡
    return result[0] if result else 0


def get_latest_log(user_id):
    """æŸ¥è©¢ç‰¹å®šç”¨æˆ¶çš„æœ€æ–°ä¸€ç¯‡æ—¥è¨˜å…§å®¹åŠ IDã€‚"""
    db = get_db()
    try:
        sql = """
            SELECT id, raw_text  -- ğŸŒŸ ä¿®æ­£ï¼šåŠ å…¥ id æ¬„ä½ ğŸŒŸ
            FROM diary_logs 
            WHERE user_id = ? 
            ORDER BY timestamp DESC  
            LIMIT 1
        """
        result = db.execute(sql, (user_id,)).fetchone()

        if result:
            # ğŸŒŸ ä¿®æ­£ï¼šè¿”å› (id, raw_text) å…ƒçµ„ ğŸŒŸ
            return (result[0], result[1])
        else:
            return None
    except Exception as e:
        print(f"æŸ¥è©¢æœ€æ–°æ—¥è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return None


def get_first_log(user_id):
    """æŸ¥è©¢ç‰¹å®šç”¨æˆ¶çš„ç¬¬ä¸€ç¯‡ï¼ˆæœ€èˆŠçš„ï¼‰æ—¥è¨˜å…§å®¹åŠ IDã€‚"""
    db = get_db()
    try:
        sql = """
            SELECT id, raw_text  -- ğŸŒŸ ä¿®æ­£ï¼šåŠ å…¥ id æ¬„ä½ ğŸŒŸ
            FROM diary_logs 
            WHERE user_id = ? 
            ORDER BY timestamp ASC  
            LIMIT 1
        """
        result = db.execute(sql, (user_id,)).fetchone()

        if result:
            # ğŸŒŸ ä¿®æ­£ï¼šè¿”å› (id, raw_text) å…ƒçµ„ ğŸŒŸ
            return (result[0], result[1])
        else:
            return None
    except Exception as e:
        print(f"æŸ¥è©¢ç¬¬ä¸€ç¯‡æ—¥è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return None


def get_nth_log(user_id, n):
    """æŸ¥è©¢ç‰¹å®šç”¨æˆ¶çš„ç¬¬ n ç¯‡æ—¥è¨˜å…§å®¹åŠ IDã€‚"""
    db = get_db()
    if n < 1:
        return None
    offset = n - 1

    try:
        sql = """
            SELECT id, raw_text  -- ğŸŒŸ ä¿®æ­£ï¼šåŠ å…¥ id æ¬„ä½ ğŸŒŸ
            FROM diary_logs 
            WHERE user_id = ? 
            ORDER BY timestamp ASC  
            LIMIT 1 
            OFFSET ?              
        """
        result = db.execute(sql, (user_id, offset)).fetchone()

        if result:
            # ğŸŒŸ ä¿®æ­£ï¼šè¿”å› (id, raw_text) å…ƒçµ„ ğŸŒŸ
            return (result[0], result[1])
        else:
            return None

    except Exception as e:
        print(f"æŸ¥è©¢ç¬¬ {n} ç¯‡æ—¥è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return None


def get_all_logs_summary(user_id):
    """
    æŸ¥è©¢ç‰¹å®šç”¨æˆ¶çš„æ‰€æœ‰æ—¥è¨˜ç´€éŒ„çš„ IDã€æ™‚é–“æˆ³å’Œå…§å®¹æ‘˜è¦ã€‚ï¼ˆå·²å¯¦ç¾æ¸…å–®é è¦½åŠŸèƒ½ï¼‰

    Returns:
        list of tuples: [(id, date_part, summary), ...] æˆ–ç©ºåˆ—è¡¨ã€‚
    """
    db = get_db()

    try:
        sql = """
            SELECT id, timestamp, raw_text 
            FROM diary_logs 
            WHERE user_id = ? 
            ORDER BY timestamp ASC
        """
        results = db.execute(sql, (user_id,)).fetchall()

        summary_list = []
        for row in results:
            log_id = row['id']
            timestamp = row['timestamp']
            raw_text = row['raw_text']

            # æ ¼å¼åŒ–æ™‚é–“æˆ³
            date_part = timestamp.split(
                'T')[0] if 'T' in timestamp else timestamp.split(' ')[0]

            # æˆªæ–·å…§å®¹
            summary = raw_text[:20] + ('...' if len(raw_text) > 20 else '')

            summary_list.append((log_id, date_part, summary))

        return summary_list

    except Exception as e:
        print(f"æŸ¥è©¢æ‰€æœ‰æ—¥è¨˜æ¸…å–®æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return []

# ----------------------------------------------------
# C. æ›´æ–° (Update) - æ–°å¢
# ----------------------------------------------------


def update_log_by_id(log_id, new_raw_text):
    """
    æ ¹æ“šæ—¥è¨˜çš„å”¯ä¸€ ID æ›´æ–°å…¶åŸå§‹å…§å®¹ (raw_text) å’Œ timestampã€‚

    Args:
        log_id (int): è¦æ›´æ–°çš„æ—¥è¨˜çš„å”¯ä¸€ ID (INTEGER)ã€‚
        new_raw_text (str): æ—¥è¨˜çš„æ–°å…§å®¹ã€‚

    Returns:
        int: å—å½±éŸ¿çš„è¡Œæ•¸ (1 è¡¨ç¤ºæˆåŠŸï¼Œ0 è¡¨ç¤ºå¤±æ•—)ã€‚
    """
    db = get_db()

    # ğŸ“ æ³¨æ„ï¼šé€™è£¡åŒæ™‚æ›´æ–°å…§å®¹å’Œæ™‚é–“æˆ³ (timestamp)ï¼Œè¡¨ç¤ºå…§å®¹æœ‰è®Šå‹•ã€‚
    sql = """
        UPDATE diary_logs
        SET raw_text = ?, timestamp = ?
        WHERE id = ?
    """
    current_time = datetime.now().isoformat()

    try:
        # ä½¿ç”¨åƒæ•¸åŒ–æŸ¥è©¢ï¼Œé˜²æ­¢ SQL æ³¨å…¥
        cursor = db.execute(sql, (new_raw_text, current_time, log_id))
        db.commit()
        return cursor.rowcount  # è¿”å›å—å½±éŸ¿çš„è¡Œæ•¸ (æœŸæœ›æ˜¯ 1)
    except Exception as e:
        print(f"æ›´æ–° ID {log_id} çš„æ—¥è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        db.rollback()
        return 0

# ----------------------------------------------------
# D. åˆªé™¤ (Delete)
# ----------------------------------------------------


def delete_all_logs(user_id):
    """åˆªé™¤ç‰¹å®šç”¨æˆ¶çš„æ‰€æœ‰æ—¥è¨˜ç´€éŒ„ã€‚"""
    db = get_db()
    try:
        cursor = db.execute(
            "DELETE FROM diary_logs WHERE user_id = ?", (user_id,))
        deleted_count = cursor.rowcount
        db.commit()
        return deleted_count
    except Exception as e:
        print(f"åˆªé™¤æ‰€æœ‰æ—¥è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return 0


def delete_nth_log(user_id, n):
    """
    åˆªé™¤ç‰¹å®šç”¨æˆ¶çš„ç¬¬ n ç¯‡æ—¥è¨˜ã€‚
    ï¼ˆä¿ç•™æ­¤å‡½å¼ä»¥æ”¯æ´èˆŠæœ‰é‚è¼¯ï¼Œä½†å»ºè­°ä½¿ç”¨ delete_log_by_id æ›´ç²¾æº–ï¼‰
    """
    db = get_db()

    if n < 1:
        return False
    offset = n - 1

    select_id_sql = """
        SELECT id 
        FROM diary_logs 
        WHERE user_id = ? 
        ORDER BY timestamp ASC  
        LIMIT 1 
        OFFSET ?
    """

    try:
        result = db.execute(select_id_sql, (user_id, offset)).fetchone()

        if result:
            log_id = result[0]
            delete_sql = "DELETE FROM diary_logs WHERE id = ?"
            cursor = db.execute(delete_sql, (log_id,))

            db.commit()
            return cursor.rowcount > 0
        else:
            return False

    except Exception as e:
        print(f"åˆªé™¤ç¬¬ {n} ç¯‡æ—¥è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return False


def delete_log_by_id(user_id, log_id_to_delete):
    """
    æ ¹æ“šä½¿ç”¨è€… ID å’Œæ—¥è¨˜çš„å”¯ä¸€ ID åˆªé™¤å–®ç¯‡æ—¥è¨˜ã€‚
    é€™ç¢ºä¿ä½¿ç”¨è€…åªèƒ½åˆªé™¤è‡ªå·±çš„æ—¥è¨˜ï¼Œä¸¦ä¸”æ˜¯ç²¾æº–åˆªé™¤çš„é—œéµã€‚
    """
    db = get_db()

    try:
        # ğŸŒŸ ä¿®æ­£ 1 (å®‰å…¨æ€§)ï¼šSQL èªå¥å¿…é ˆåŒæ™‚æª¢æŸ¥ user_id å’Œ idï¼Œç¢ºä¿åªèƒ½åˆªé™¤è‡ªå·±çš„æ—¥è¨˜ã€‚
        # ä¿®æ­£ 2 (è®Šæ•¸)ï¼šå°‡åƒæ•¸åˆ—è¡¨ (log_id,) æ›¿æ›ç‚º (user_id, log_id_to_delete)
        sql = "DELETE FROM diary_logs WHERE user_id = ? AND id = ?"
        cursor = db.execute(sql, (user_id, log_id_to_delete)) 
        
        db.commit()
        
        # æª¢æŸ¥æ˜¯å¦æœ‰è¨˜éŒ„è¢«åˆªé™¤ (å¦‚æœ rowcount > 0 è¡¨ç¤ºæˆåŠŸåˆªé™¤)
        return cursor.rowcount > 0
        
    except Exception as e:
        # ğŸŒŸ ä¿®æ­£ 3 (è®Šæ•¸)ï¼šå°‡ print èªå¥ä¸­çš„ log_id æ›¿æ›ç‚º log_id_to_delete
        print(f"æ ¹æ“š ID {log_id_to_delete} åˆªé™¤æ—¥è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return False


# ----------------------------------------------------
# E. V4 æ–°å¢ï¼šæ¯é€±å½™æ•´ (Retrieve Weekly Logs)
# ----------------------------------------------------

def get_weekly_logs(user_id, days=7):
    """
    æŸ¥è©¢ç‰¹å®šç”¨æˆ¶éå» X å¤©çš„æ‰€æœ‰æ—¥è¨˜ç´€éŒ„ï¼Œç”¨æ–¼æ¯é€±ç¸½çµã€‚

    Args:
        user_id (str): ä½¿ç”¨è€…çš„å”¯ä¸€ IDã€‚
        days (int): è¦æŸ¥è©¢éå»çš„å¤©æ•¸ (é è¨­ç‚º 7 å¤©)ã€‚

    Returns:
        list of str: éå» X å¤©çš„æ‰€æœ‰æ—¥è¨˜å…§å®¹çš„åˆ—è¡¨ã€‚
    """
    # ç²å–è³‡æ–™åº«é€£ç·šï¼Œä½¿ç”¨ Flask çš„ g
    db = get_db()

    # ğŸŒŸ è¨ˆç®—èµ·å§‹æ™‚é–“ ğŸŒŸ
    # è¨ˆç®— X å¤©å‰çš„æ™‚é–“ï¼Œä¸¦è½‰æ›æˆ SQLite å„²å­˜çš„ ISO æ ¼å¼å­—ä¸²
    seven_days_ago = (datetime.now() - timedelta(days=days)).isoformat()

    try:
        sql = """
            SELECT raw_text
            FROM diary_logs 
            WHERE user_id = ? AND timestamp >= ? 
            ORDER BY timestamp ASC
        """
        # åŸ·è¡ŒæŸ¥è©¢ï¼Œéæ¿¾å‡ºæ™‚é–“æˆ³å¤§æ–¼ä¸ƒå¤©å‰çš„ç´€éŒ„
        # æ³¨æ„ï¼šSQLite æœƒå° ISO æ ¼å¼çš„ TEXT é€²è¡Œæ­£ç¢ºçš„å­—ä¸²æ¯”è¼ƒ
        results = db.execute(sql, (user_id, seven_days_ago)).fetchall()

        # å°‡æ¯ä¸€è¡Œçš„ 'raw_text' æå–å‡ºä¾†ï¼Œçµ„åˆæˆä¸€å€‹åˆ—è¡¨
        log_texts = [row['raw_text'] for row in results]

        return log_texts

    except Exception as e:
        print(f"æŸ¥è©¢æ¯é€±æ—¥è¨˜æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return []


if __name__ == '__main__':
    # æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚ï¼Œåˆå§‹åŒ–è³‡æ–™åº«
    init_db()

    # ----------------------------------------------------
    # ğŸŒŸ UPDATE åŠŸèƒ½å–®å…ƒæ¸¬è©¦ (ä¿®æ­£ç‰ˆï¼Œä¸ä¾è³´ Flask g) ğŸŒŸ
    # ----------------------------------------------------
    print("\n--- åŸ·è¡Œ UPDATE åŠŸèƒ½æ¸¬è©¦ ---")

    TEST_USER_ID = "update_test_user_id"
    conn = None  # åˆå§‹åŒ–æœ¬åœ°é€£ç·šè®Šæ•¸

    try:
        # å»ºç«‹ä¸€å€‹ç¨ç«‹æ–¼ Flask çš„æœ¬åœ°è³‡æ–™åº«é€£ç·šé€²è¡Œæ¸¬è©¦
        conn = sqlite3.connect(DB_NAME)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # ç¢ºä¿åˆªé™¤ä¸Šä¸€æ¬¡çš„æ®˜ç•™æ¸¬è©¦è³‡æ–™
        cursor.execute(
            "DELETE FROM diary_logs WHERE user_id = ?", (TEST_USER_ID,))

        # æ’å…¥ä¸€ç¯‡åˆå§‹æ¸¬è©¦æ—¥è¨˜
        original_text = "é€™æ˜¯åŸå§‹çš„æ—¥è¨˜å…§å®¹ï¼Œæˆ‘å€‘å°‡æœƒæŠŠå®ƒæ›´æ–°ã€‚"
        current_time = datetime.now().isoformat()
        cursor.execute(
            "INSERT INTO diary_logs (user_id, timestamp, raw_text) VALUES (?, ?, ?)",
            (TEST_USER_ID, current_time, original_text)
        )
        conn.commit()

        # ç²å–æœ€æ–°è¨˜éŒ„çš„ ID å’Œå…§å®¹
        cursor.execute(
            "SELECT id, raw_text FROM diary_logs WHERE user_id = ? ORDER BY timestamp DESC LIMIT 1",
            (TEST_USER_ID,)
        )
        latest_log = cursor.fetchone()

        if latest_log:
            log_id_to_update = latest_log['id']
            original_content_check = latest_log['raw_text']
            new_text = "âœ¨ æˆåŠŸæ›´æ–°ï¼é€™å°±æ˜¯æˆ‘å€‘ç”¨ UPDATE å¯«å…¥çš„æ–°å…§å®¹ã€‚"

            print(f"è¦æ›´æ–°çš„ç´€éŒ„ ID: {log_id_to_update}")
            print(f"åŸå§‹å…§å®¹: {original_content_check[:20]}...")

            # 2. åŸ·è¡Œ UPDATE æ“ä½œ (ç›´æ¥æ¨¡æ“¬ update_log_by_id çš„ SQL)
            # ç”±æ–¼ update_log_by_id ä¾è³´ get_db()ï¼Œæˆ‘å€‘ç›´æ¥åœ¨é€™è£¡åŸ·è¡Œ SQL
            update_sql = """
                UPDATE diary_logs
                SET raw_text = ?, timestamp = ?
                WHERE id = ?
            """
            new_timestamp = datetime.now().isoformat()
            cursor.execute(
                update_sql, (new_text, new_timestamp, log_id_to_update))
            rows = cursor.rowcount
            conn.commit()

            # 3. é©—è­‰çµæœ
            cursor.execute(
                "SELECT id, raw_text FROM diary_logs WHERE user_id = ? ORDER BY timestamp DESC LIMIT 1",
                (TEST_USER_ID,)
            )
            updated_log = cursor.fetchone()

            if rows == 1 and updated_log and updated_log['raw_text'] == new_text:
                print(f"âœ… æ¸¬è©¦æˆåŠŸ: æˆåŠŸæ›´æ–° {rows} ç­†ç´€éŒ„ã€‚")
                print(f"âœ… æ›´æ–°å¾Œå…§å®¹ (æ‘˜è¦): {updated_log['raw_text'][:20]}...")
            else:
                print(f"âŒ æ¸¬è©¦å¤±æ•—: æ›´æ–°å¤±æ•—æˆ–å…§å®¹ä¸åŒ¹é…ã€‚å—å½±éŸ¿è¡Œæ•¸: {rows}")
        else:
            print("âŒ æ¸¬è©¦å¤±æ•—ï¼šç„¡æ³•æ‰¾åˆ°æ¸¬è©¦ç”¨çš„æœ€æ–°ç´€éŒ„ï¼Œè«‹æª¢æŸ¥ INSERT æ˜¯å¦æˆåŠŸã€‚")

    except Exception as e:
        print(f"âŒ æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {e}")
    finally:
        # 4. æ¸…ç†é€£ç·šå’Œæ¸¬è©¦è³‡æ–™ (åªåœ¨æœ¬åœ°é€£ç·šå­˜åœ¨æ™‚æ‰æ“ä½œ)
        if conn:
            # åˆªé™¤æ¸¬è©¦è³‡æ–™
            conn.execute(
                "DELETE FROM diary_logs WHERE user_id = ?", (TEST_USER_ID,))
            conn.commit()
            conn.close()
            print("--- æ¸¬è©¦è³‡æ–™å·²æ¸…ç†ä¸¦é—œé–‰é€£ç·š ---")


# ... (æ‰€æœ‰çš„å‡½å¼ï¼ŒåŒ…æ‹¬ V4 çš„ get_weekly_logs)
    # ----------------------------------------------------
    # ğŸŒŸ V4 æ¸¬è©¦ï¼šæ¸¬è©¦ get_weekly_logs (æ–°çš„è¿½åŠ åœ¨é€™è£¡) ğŸŒŸ
    # ----------------------------------------------------
    print("\n--- åŸ·è¡Œ V4 æ¯é€±å½™æ•´åŠŸèƒ½æ¸¬è©¦ ---")

    # å‡è¨­æ‚¨æ‰‹å‹•æ’å…¥ä¸€äº› TEST_USER_ID çš„æ—¥è¨˜ç´€éŒ„ï¼Œç¢ºä¿æœ‰åœ¨ 7 å¤©å…§çš„è³‡æ–™
    V4_TEST_USER = "v4_weekly_test"
    conn = None

    try:
        conn = sqlite3.connect(DB_NAME)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()

        # ã€æ¸…ç†ã€‘ç¢ºä¿æ²’æœ‰èˆŠçš„ V4 æ¸¬è©¦è³‡æ–™
        cursor.execute(
            "DELETE FROM diary_logs WHERE user_id = ?", (V4_TEST_USER,))
        conn.commit()

        # ã€æº–å‚™ã€‘æ’å…¥å…©ç¯‡ä»Šæ—¥çš„æ—¥è¨˜
        today = datetime.now().isoformat()
        cursor.execute("INSERT INTO diary_logs (user_id, timestamp, raw_text) VALUES (?, ?, ?)",
                       (V4_TEST_USER, today, "ä»Šå¤©å¤©æ°£å¾ˆå¥½ï¼Œé©åˆæ¸¬è©¦ã€‚"))
        cursor.execute("INSERT INTO diary_logs (user_id, timestamp, raw_text) VALUES (?, ?, ?)",
                       (V4_TEST_USER, today, "é€™æ˜¯ä»Šå¤©ç¬¬äºŒç¯‡ï¼Œæ‡‰è¢«æ’ˆå‡ºã€‚"))
        conn.commit()

        # ã€åŸ·è¡Œã€‘ä½¿ç”¨ V4 å‡½å¼çš„æ ¸å¿ƒé‚è¼¯ä¾†æ¸¬è©¦
        seven_days_ago = (datetime.now() - timedelta(days=7)).isoformat()
        sql = "SELECT raw_text FROM diary_logs WHERE user_id = ? AND timestamp >= ? ORDER BY timestamp ASC"
        results = conn.execute(sql, (V4_TEST_USER, seven_days_ago)).fetchall()

        weekly_logs = [row['raw_text'] for row in results]

        # ã€é©—è­‰ã€‘
        if len(weekly_logs) == 2:
            print(f"âœ… V4 æ¸¬è©¦æˆåŠŸï¼šæ‰¾åˆ° {len(weekly_logs)} ç¯‡éå» 7 å¤©çš„æ—¥è¨˜ã€‚")
        else:
            print(f"âŒ V4 æ¸¬è©¦å¤±æ•—ï¼šé æœŸ 2 ç¯‡ï¼Œä½†åªæ‰¾åˆ° {len(weekly_logs)} ç¯‡ã€‚")

    except Exception as e:
        print(f"âŒ V4 æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {e}")
    finally:
        if conn:
            # ã€æ¸…ç†ã€‘åˆªé™¤ V4 æ¸¬è©¦è³‡æ–™
            conn.execute(
                "DELETE FROM diary_logs WHERE user_id = ?", (V4_TEST_USER,))
            conn.commit()
            conn.close()
            print("--- V4 æ¸¬è©¦é€£ç·šå·²é—œé–‰ ---")
