# -*- coding: utf-8 -*-
"""v1 SQLite ç´€éŒ„.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1IMoSVjIlJnL6XWb02l36Pgmsh7t_r4g0

##æŽ›è¼‰ Google Drive
"""

from google.colab import drive
drive.mount('/content/drive')

"""##åŠ å…¥å°ˆæ¡ˆè·¯å¾‘"""

import os
import sys
from flask import Flask, request, abort

# ðŸŒŸ 0. ç’°å¢ƒè¨­å®šèˆ‡è¨ºæ–· (å¼·åˆ¶åœ¨åŒ¯å…¥å‰åŸ·è¡Œ) ðŸŒŸ
# è«‹ç¢ºä¿ Cell 1: drive.mount('/content/drive') å·²ç¶“æˆåŠŸé‹è¡Œ

PROJECT_PATH = '/content/drive/MyDrive/projects/LINE BOT'

# è¨ºæ–·ï¼šæª¢æŸ¥æª”æ¡ˆæ˜¯å¦çœŸçš„å­˜åœ¨æ–¼ Python è¦–è§’ä¸‹çš„è·¯å¾‘
FILE_CHECK_NAME = 'v1_sqlite_dataseat.py'
FILE_CHECK_PATH = os.path.join(PROJECT_PATH, FILE_CHECK_NAME)

# --- è¨ºæ–·é‚è¼¯ ---
if os.path.exists(FILE_CHECK_PATH):
    print(f"âœ… è¨ºæ–·æˆåŠŸï¼šæ–‡ä»¶ '{FILE_CHECK_NAME}' å­˜åœ¨æ–¼ {PROJECT_PATH}ã€‚")
    if PROJECT_PATH not in sys.path:
        sys.path.append(PROJECT_PATH)
        print(f"âœ… å·²å°‡è·¯å¾‘åŠ å…¥ç³»çµ±æœå°‹æ¸…å–®ã€‚")
else:
    # å¦‚æžœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œç«‹å³åœæ­¢ä¸¦å ±å‘ŠéŒ¯èª¤
    print(f"âŒ è¨ºæ–·å¤±æ•—ï¼šæ–‡ä»¶ '{FILE_CHECK_NAME}' ä¸å­˜åœ¨æ–¼ {PROJECT_PATH}ã€‚")
    print("è«‹ä»”ç´°æª¢æŸ¥ Google Drive ä¸Šçš„è³‡æ–™å¤¾åç¨±æ˜¯å¦æœ‰éš±è—çš„ç©ºæ ¼æˆ–ç¬¦è™Ÿã€‚")
    raise FileNotFoundError("è·¯å¾‘æˆ–æª”æ¡ˆåç¨±éŒ¯èª¤ï¼Œç„¡æ³•ç¹¼çºŒã€‚")
# --- è¨ºæ–·çµæŸ ---

# 1. å°Žå…¥æ‚¨çš„è³‡æ–™åº«å‡½å¼ (ç¾åœ¨è·¯å¾‘å·²è¨­å®šï¼ŒåŒ¯å…¥æ‡‰è©²æˆåŠŸ)
from v1_sqlite_dataseat import init_db, insert_log, close_db, get_user_log_count

# ... (LINE Bot SDK å°Žå…¥å’Œ Flask ç¨‹å¼ç¢¼æŽ¥åœ¨å¾Œé¢)
# ...

# (è«‹ç¢ºä¿ Flask/LINE Bot ç¨‹å¼ç¢¼æ˜¯æŽ¥åœ¨å¾Œé¢ï¼Œè€Œä¸æ˜¯åªæœ‰é€™æ®µ)

"""##1) å®‰è£å¥—ä»¶ï¼ˆæŒ‡å®šç‰ˆæœ¬ç¯„åœï¼‹ç”¨é€”è¨»è§£ï¼‰"""

# å®‰è£ LINE Bot SDK v3ï¼ˆå®˜æ–¹æœ€æ–°ä¸»ç·šï¼‰
!pip install "line-bot-sdk>=3.0.0,<4.0.0"

# å®‰è£ Flaskï¼ˆWeb æ¡†æž¶ï¼Œæä¾› webhook ç«¯é»žï¼‰
!pip install "Flask>=3.0.0,<4.0.0"

# å®‰è£ pyngrokï¼ˆæŠŠæœ¬æ©Ÿ/Colab 5000 port æ˜ å°„æˆå…¬é–‹ HTTPSï¼‰
!pip install "pyngrok>=7.0.0,<8.0.0"

"""##2) é–‹ ngrokï¼ˆå…ˆåŸ·è¡Œé€™ä¸€æ ¼æ‹¿åˆ°å…¬é–‹ç¶²å€ï¼‰"""

from pyngrok import ngrok

# æ›æˆä½ è‡ªå·±çš„ ngrok authtoken
NGROK_AUTHTOKEN = "2nh1S1yuCNhyHz7E9kibC5G9jfJ_5poDL8LVgJgfAm2a1ZJRc"   # ä¾‹ï¼š2pEWt4...ï¼ˆä¸è¦å…¬é–‹åœ¨ GitHubï¼‰
PORT = 5000

# è¨­å®šé‡‘é‘°
ngrok.set_auth_token(NGROK_AUTHTOKEN)

# é—œé–‰èˆŠéš§é“ï¼ˆé¿å…é‡è¤‡ï¼‰
for t in ngrok.get_tunnels():
    ngrok.disconnect(t.public_url)

# å»ºç«‹æ–°éš§é“ï¼Œå–å¾—å…¬é–‹ HTTPS ç¶²å€
public_url = ngrok.connect(PORT, "http").public_url

print("ðŸ‘‰ å¤–ç¶²ç¶²å€ï¼š", public_url)
print("Webhook URLï¼š", public_url + "/callback")

"""##3) LINE Bot Echo ç¨‹å¼ï¼ˆv3 SDK æ­£å¼å¯«æ³•ï¼‰"""

#å¾žLine bot sdk pyplç¶²ç«™æ‰¾åˆ°ç¨‹å¼ç¢¼è²¼ä¸Š
#https://pypi.org/project/line-bot-sdk/
import os
from flask import Flask, request, abort

# ðŸŒŸ å°Žå…¥æ‚¨çš„è³‡æ–™åº«å‡½å¼ (ä½¿ç”¨æ‚¨ç¢ºèªçš„æª”å)
from v1_sqlite_dataseat import init_db, insert_log, close_db, get_user_log_count

from linebot.v3 import (
    WebhookHandler
)
from linebot.v3.exceptions import (
    InvalidSignatureError
)
from linebot.v3.messaging import (
    Configuration,
    ApiClient,
    MessagingApi,
    ReplyMessageRequest,
    TextMessage
)
from linebot.v3.webhooks import (
    MessageEvent,
    TextMessageContent
)

app = Flask(__name__)

# æ†‘è­‰è¨­å®šï¼šè«‹æ›¿æ›æˆæ‚¨çš„ LINE Bot æ†‘è­‰
CHANNEL_ACCESS_TOKEN = os.environ.get('LINE_ACCESS_TOKEN', '+Ri09o6iK7SXuNUaZEjWtlf9mZLp1xAt8NPXDVCN0shGvq1wvris4Oo29FZWdNqm7BW5a559L0klMfDltAo4qvsr1GI7OXMW2lW/mcZZYd2pwDpjrPQdxmKQ5W3vpYRC1VSq4rM84ksy+BybGREwygdB04t89/1O/w1cDnyilFU=')
CHANNEL_SECRET = os.environ.get('LINE_CHANNEL_SECRET', '4bc05bd9e903340338507195040bd2ff')

configuration = Configuration(access_token=CHANNEL_ACCESS_TOKEN)
handler = WebhookHandler(CHANNEL_SECRET)

# ðŸŒŸ æ•¸æ“šåº«å„ªåŒ–ï¼šè¨»å†Šè³‡æ–™åº«é—œé–‰å‡½å¼ ðŸŒŸ
# ç¢ºä¿æ¯å€‹è«‹æ±‚çµæŸå¾Œéƒ½æœƒé—œé–‰é€£ç·šï¼Œé‡‹æ”¾è³‡æº
app.teardown_appcontext(close_db)


@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    app.logger.info("Request body: " + body)

    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        app.logger.info("Invalid signature. Please check your channel access token/channel secret.")
        abort(400)

    return 'OK'


@handler.add(MessageEvent, message=TextMessageContent)
def handle_message(event):
    """
    è™•ç†ä½¿ç”¨è€…å‚³é€çš„æ–‡å­—è¨Šæ¯ï¼š
    1. å„²å­˜è¨Šæ¯åˆ°è³‡æ–™åº« (V1 æ ¸å¿ƒ)ã€‚
    2. å›žè¦†å€‹äººåŒ–çš„æ—¥è¨˜ç¸½æ•¸ã€‚
    """
    user_id = event.source.user_id
    user_diary = event.message.text

    # 1. ðŸŒŸ å„²å­˜æ—¥è¨˜ï¼šå°‡è¨Šæ¯å¯«å…¥ Google Drive ä¸Šçš„ SQLite è³‡æ–™åº«
    insert_log(user_id=user_id, raw_text=user_diary)

    # 2. æŸ¥è©¢æ—¥è¨˜ç¸½æ•¸
    total_logs = get_user_log_count(user_id)

    # 3. å›žè¦†ä½¿ç”¨è€…
    reply_text = (
        f"ðŸ“ æ‚¨çš„æ—¥è¨˜å·²æˆåŠŸæ”¶éŒ„ï¼\n"
        f"é€™æ˜¯æ‚¨å¯«ä¸‹çš„ç¬¬ {total_logs} ç¯‡ç´€éŒ„ã€‚\n"
        f"æˆ‘å€‘æœƒæº«æŸ”åœ°ç‚ºæ‚¨ä¿ç®¡é€™ä»½çè²´çš„å›žæ†¶ã€‚"
    )

    with ApiClient(configuration) as api_client:
        line_bot_api = MessagingApi(api_client)
        line_bot_api.reply_message_with_http_info(
            ReplyMessageRequest(
                reply_token=event.reply_token,
                messages=[TextMessage(text=reply_text)]
            )
        )

if __name__ == "__main__":
    # ðŸŒŸ æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•å‰ï¼Œå…ˆåˆå§‹åŒ–è³‡æ–™åº« ðŸŒŸ
    init_db()

    # é‹è¡Œ Flask æœå‹™
    app.run(port=5000)